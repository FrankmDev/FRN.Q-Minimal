---
const navLinks = [
  { href: '#proyectos', label: 'Arquitecturas', labelMobile: '[Arquitecturas]' },
  { href: '#sobre-mi', label: 'Estudio', labelMobile: '[Estudio]' },
  { href: '#contacto', label: 'Contacto', labelMobile: '[Contacto]' },
];
---

<header class="header" id="header" role="banner">
  <div class="header-accent" aria-hidden="true">
    <div class="accent-line"></div>
    <div class="accent-blocks">
      <span></span><span></span><span></span>
    </div>
  </div>

  <div class="container header-inner">
    <a href="/" class="logo" aria-label="FRN.Q - Inicio">
      <div class="logo-icon" aria-hidden="true">
        <div class="icon-grid">
          <span></span><span></span>
          <span></span><span></span>
        </div>
      </div>
      <span class="logo-text">FRN.Q</span>
    </a>

    <nav class="nav" id="nav" role="navigation" aria-label="Navegación principal">
      {navLinks.map(link => (
        <a href={link.href} class="nav-link">
          <span class="link-bracket" aria-hidden="true">[</span>
          <span class="link-text">{link.label}</span>
          <span class="link-bracket" aria-hidden="true">]</span>
        </a>
      ))}
    </nav>

    <div class="header-actions">
      <button 
        class="theme-toggle" 
        id="theme-toggle" 
        aria-label="Cambiar tema (claro/oscuro)"
        type="button"
      >
        <span class="sr-only">Cambiar tema</span>
        <div class="toggle-face" aria-hidden="true">
          <span class="face-light">☼</span>
          <span class="face-dark">☾</span>
        </div>
      </button>
      <a href="#contacto" class="header-cta">
        <span class="cta-text">Evaluación</span>
        <span class="cta-arrow" aria-hidden="true">→</span>
      </a>
      <button
        class="hamburger"
        id="hamburger"
        aria-label="Abrir menú"
        aria-expanded="false"
        aria-controls="mobile-nav"
        type="button"
      >
        <span class="hamburger-line" aria-hidden="true"></span>
        <span class="hamburger-line" aria-hidden="true"></span>
        <span class="sr-only">Menú</span>
      </button>
    </div>
  </div>

  <!-- Mobile nav panel -->
  <div 
    class="mobile-nav" 
    id="mobile-nav"
    role="dialog"
    aria-label="Menú móvil"
    aria-modal="true"
  >
    <div class="container">
      {navLinks.map(link => (
        <a href={link.href} class="mobile-link">{link.labelMobile}</a>
      ))}
      <a href="#contacto" class="mobile-cta">
        <span>Evaluación</span>
        <span class="cta-arrow" aria-hidden="true">→</span>
      </a>
    </div>
  </div>

</header>

<!-- Progress bar - separada del header para evitar solapamiento -->
<div class="header-progress" id="header-progress" aria-hidden="true" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
  <div class="progress-bar" id="progress-bar"></div>
</div>

<script>
  // Theme toggle with improved handling
  const themeToggle = document.getElementById("theme-toggle");
  
  themeToggle?.addEventListener("click", () => {
    const html = document.documentElement;
    const currentTheme = html.getAttribute("data-theme") || "light";
    const nextTheme = currentTheme === "light" ? "dark" : "light";
    
    html.setAttribute("data-theme", nextTheme);
    html.style.colorScheme = nextTheme;
    localStorage.setItem("theme", nextTheme);
    
    // Update meta theme-color
    const metaThemeColor = document.querySelector('meta[name="theme-color"]');
    if (metaThemeColor) {
      metaThemeColor.setAttribute("content", nextTheme === "dark" ? "#0a0a0a" : "#ffffff");
    }
  });

  // Hamburger toggle with accessibility improvements
  const hamburger = document.getElementById("hamburger");
  const mobileNav = document.getElementById("mobile-nav");
  const progressBar = document.getElementById("progress-bar");
  const headerProgress = document.getElementById("header-progress");

  function toggleMenu() {
    const isOpen = hamburger?.getAttribute("aria-expanded") === "true";
    const newState = !isOpen;
    
    hamburger?.setAttribute("aria-expanded", String(newState));
    hamburger?.setAttribute("aria-label", newState ? "Cerrar menú" : "Abrir menú");
    hamburger?.classList.toggle("is-active", newState);
    mobileNav?.classList.toggle("is-open", newState);
    
    // Prevent body scroll when menu is open
    document.body.style.overflow = newState ? "hidden" : "";
  }

  hamburger?.addEventListener("click", toggleMenu);

  // Close mobile nav on link click
  mobileNav?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      hamburger?.setAttribute("aria-expanded", "false");
      hamburger?.setAttribute("aria-label", "Abrir menú");
      hamburger?.classList.remove("is-active");
      mobileNav?.classList.remove("is-open");
      document.body.style.overflow = "";
    });
  });

  // Close menu on escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && hamburger?.getAttribute("aria-expanded") === "true") {
      toggleMenu();
      hamburger?.focus();
    }
  });

  // Scroll: progress bar + header shadow (throttled via rAF)
  let ticking = false;
  
  window.addEventListener(
    "scroll",
    () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          const scrollY = window.scrollY;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const scrolled = docHeight > 0 ? (scrollY / docHeight) : 0;
          
          if (progressBar) {
            progressBar.style.width = `${Math.min(scrolled * 100, 100)}%`;
          }
          
          if (headerProgress) {
            headerProgress.setAttribute("aria-valuenow", String(Math.round(scrolled * 100)));
          }
          
          ticking = false;
        });
        ticking = true;
      }
    },
    { passive: true }
  );
  
  // Handle visibility change to avoid animation glitches
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      ticking = false;
    }
  });
  
  // Calcular posición de la barra de progreso (header siempre visible)
  function updateProgressBarPosition() {
    const header = document.getElementById("header");
    const mobileNav = document.getElementById("mobile-nav");
    if (!header) return;
    
    // Altura del header + menú móvil si está abierto + separación de 8px
    let headerHeight = header.offsetHeight;
    const progressTop = headerHeight + 8;
    document.documentElement.style.setProperty('--progress-top', `${progressTop}px`);
  }
  
  // Calcular posición inicial
  updateProgressBarPosition();
  window.addEventListener("resize", updateProgressBarPosition);
  
  // Actualizar cuando cambie el menú móvil
  if (mobileNav) {
    const mobileNavObserver = new MutationObserver(() => {
      setTimeout(updateProgressBarPosition, 50);
      setTimeout(updateProgressBarPosition, 350);
    });
    mobileNavObserver.observe(mobileNav, { attributes: true, attributeFilter: ['class'] });
  }
</script>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: var(--z-fixed, 300);
    background: var(--bg);
    transition: 
      box-shadow var(--transition-fast),
      transform var(--transition-base);
    will-change: transform;
  }

  .header-accent {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    display: flex;
    pointer-events: none;
  }

  .accent-line {
    flex: 1;
    background: var(--border);
  }

  .accent-blocks {
    display: flex;
  }

  .accent-blocks span {
    width: 40px;
    height: 4px;
    background: var(--border);
    margin-left: 4px;
  }

  .accent-blocks span:nth-child(2) { width: 60px; }
  .accent-blocks span:nth-child(3) { width: 30px; }

  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: var(--space-md);
    padding-bottom: var(--space-md);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border: 2px solid var(--border);
    background: var(--bg);
    box-shadow: var(--shadow-brutal);
    transition: 
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
    position: relative;
  }

  .logo:hover {
    transform: translate(-3px, -3px);
    box-shadow: 7px 7px 0 var(--border);
  }
  
  .logo:focus-visible {
    outline: 3px solid var(--text);
    outline-offset: 3px;
  }

  .logo-icon {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border);
    padding: 2px;
    flex-shrink: 0;
  }

  .icon-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2px;
    height: 100%;
  }

  .icon-grid span {
    background: var(--border);
  }

  .logo-text {
    font-family: var(--font-mono);
    font-size: 1.125rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  /* Desktop nav */
  .nav {
    display: none;
    gap: var(--space-xl);
  }

  @media (min-width: 900px) {
    .nav {
      display: flex;
    }
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    padding: var(--space-sm);
    position: relative;
    transition: opacity var(--transition-fast);
  }

  .link-bracket {
    opacity: 0.3;
    transition: opacity var(--transition-base);
  }

  .nav-link:hover .link-bracket,
  .nav-link:focus .link-bracket {
    opacity: 1;
  }
  
  .nav-link:hover {
    opacity: 0.8;
  }

  /* Header actions */
  .header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .theme-toggle {
    width: 44px;
    height: 44px;
    border: 2px solid var(--border);
    background: var(--bg);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: 
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-toggle:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 var(--border);
  }
  
  .theme-toggle:focus-visible {
    outline: 3px solid var(--text);
    outline-offset: 3px;
  }

  .toggle-face {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .face-light,
  .face-dark {
    position: absolute;
    font-size: 1.25rem;
    transition: opacity var(--transition-base), transform var(--transition-base);
  }

  .face-dark {
    opacity: 0;
    transform: rotate(-90deg);
  }

  [data-theme="dark"] .face-light {
    opacity: 0;
    transform: rotate(90deg);
  }

  [data-theme="dark"] .face-dark {
    opacity: 1;
    transform: rotate(0deg);
  }

  .header-cta {
    display: none;
    align-items: center;
    gap: var(--space-sm);
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    background: var(--text);
    color: var(--bg);
    border: 2px solid var(--text);
    box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.15);
    transition: 
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  @media (min-width: 900px) {
    .header-cta {
      display: flex;
    }
  }

  .header-cta:hover {
    transform: translate(-3px, -3px);
    box-shadow: 7px 7px 0 rgba(0, 0, 0, 0.15);
  }
  
  /* En modo oscuro, sombra clara */
  [data-theme="dark"] .header-cta {
    border-color: var(--text);
    box-shadow: 4px 4px 0 rgba(255, 255, 255, 0.12);
  }
  
  [data-theme="dark"] .header-cta:hover {
    box-shadow: 7px 7px 0 rgba(255, 255, 255, 0.12);
  }
  
  .header-cta:focus-visible {
    outline: 3px solid var(--text);
    outline-offset: 3px;
  }

  .cta-arrow {
    transition: transform var(--transition-base);
  }

  .header-cta:hover .cta-arrow {
    transform: translateX(4px);
  }

  /* Hamburger */
  .hamburger {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
    width: 44px;
    height: 44px;
    border: 2px solid var(--border);
    background: var(--bg);
    cursor: pointer;
    padding: 12px;
    transition: 
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  .hamburger:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 var(--border);
  }
  
  .hamburger:focus-visible {
    outline: 3px solid var(--text);
    outline-offset: 3px;
  }

  @media (min-width: 900px) {
    .hamburger {
      display: none;
    }
  }

  .hamburger-line {
    display: block;
    width: 100%;
    height: 2px;
    background: var(--text);
    transition: all var(--transition-base);
    transform-origin: center;
  }

  .hamburger.is-active .hamburger-line:first-child {
    transform: translateY(4px) rotate(45deg);
  }

  .hamburger.is-active .hamburger-line:last-child {
    transform: translateY(-4px) rotate(-45deg);
  }

  /* Mobile nav panel */
  .mobile-nav {
    max-height: 0;
    overflow: hidden;
    background: var(--bg);
    border-bottom: 0 solid var(--border);
    transition:
      max-height var(--transition-base),
      border-width var(--transition-fast);
    visibility: hidden;
  }

  .mobile-nav.is-open {
    max-height: 400px;
    border-bottom-width: 2px;
    visibility: visible;
  }

  @media (min-width: 900px) {
    .mobile-nav {
      display: none;
    }
  }

  .mobile-nav .container {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding-top: var(--space-md);
    padding-bottom: var(--space-lg);
  }

  .mobile-link {
    display: block;
    padding: var(--space-md) 0;
    font-size: 1rem;
    font-weight: 600;
    font-family: var(--font-mono);
    border-bottom: 1px solid var(--border);
    opacity: 0.6;
    transition:
      opacity var(--transition-fast),
      padding-left var(--transition-fast),
      color var(--transition-fast);
  }

  .mobile-link:hover,
  .mobile-link:focus {
    opacity: 1;
    padding-left: var(--space-sm);
  }

  .mobile-cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
    padding: var(--space-md) var(--space-xl);
    font-weight: 700;
    font-size: 0.875rem;
    background: var(--text);
    color: var(--bg);
    border: 2px solid var(--border);
    box-shadow: var(--shadow-brutal);
    text-transform: uppercase;
    transition: 
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  .mobile-cta:hover {
    transform: translate(-3px, -3px);
    box-shadow: 7px 7px 0 var(--border);
  }
  
  .mobile-cta:focus-visible {
    outline: 3px solid var(--text);
    outline-offset: 3px;
  }

  /* Progress bar - separada del header con espacio */
  .header-progress {
    position: fixed;
    top: var(--progress-top, 90px); /* posición calculada dinámicamente por JS */
    left: 0;
    right: 0;
    height: 6px;
    background: var(--bg-alt);
    overflow: hidden;
    z-index: calc(var(--z-fixed, 300) - 1);
    transition: 
      top var(--transition-fast),
      transform var(--transition-base),
      opacity var(--transition-base);
  }

  .progress-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: var(--border);
    width: 0%;
    transition: width 0.1s linear;
    will-change: width;
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .header,
    .logo,
    .theme-toggle,
    .header-cta,
    .hamburger,
    .mobile-nav,
    .mobile-link,
    .mobile-cta {
      transition: none !important;
    }
  }
</style>
